#!/usr/bin/env bash

# This Bash script gracefully restarts Gunicorn by
# reloading workers one at a time

echo "Checking if Gunicorn is running..."

# Check if Gunicorn is running by searching for its process ID
GUNICORN_PID="$(pgrep gunicorn)"

if [[ -z "$GUNICORN_PID" ]]; then
  echo "Gunicorn is not running, starting a new process..."
  # Start Gunicorn with 3 workers
  gunicorn -w 3 myapp:app -b 0.0.0.0:8000 --pid /run/gunicorn.pid --daemon
  echo "Gunicorn started with PID $(cat /run/gunicorn.pid)"
else
  echo "Gunicorn is running with PID $GUNICORN_PID"
  echo "Reloading Gunicorn gracefully..."
  # Send a HUP signal to Gunicorn to gracefully restart workers
  kill -HUP "$GUNICORN_PID"
  echo "Gunicorn reloaded"
fi